@page "/establishments/Admin"
@using webapi_peso
@using webapi_peso.ViewModels
@inject HttpClient Http
@inject IJSRuntime JS

<div class="profile-page manads">
    <div class="jf-card">
        <h3 class="fw-bold mb-3">Manage Establishments</h3>

        <!-- STATUS FILTER BUTTONS -->
        <div class="nsrp-tabs">
            <button class="nsrp-tab @(selectedStatus == 0 ? "nsrp-tab active" : "nsrp-tab")"
                    @onclick="() => ChangeStatus(0)">
                Pending
            </button>

            <button class="nsrp-tab @(selectedStatus == 1 ? "nsrp-tab active" : "nsrp-tab")"
                    @onclick="() => ChangeStatus(1)">
                Approved
            </button>

            <button class="nsrp-tab @(selectedStatus == 2 ? "nsrp-tab active" : "nsrp-tab")"
                    @onclick="() => ChangeStatus(2)">
                Denied
            </button>
        </div>

        @if (isLoading)
        {
            <div class="text-center mt-4">
                <div class="spinner-border"></div>
                <p>Loading establishments...</p>
            </div>
        }
        else if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="jf-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact Person</th>
                            <th>Email</th>
                            <th>Date Registered</th>
                            <th style="width: 120px;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var est in pagedEstablishments)
                        {
                            var ed = est.EmployerDetails;

                            <tr>
                                <td>@ed?.EstablishmentName</td>
                                <td>@ed?.ContactFullName</td>
                                <td>@ed?.ContactEmailAddress</td>
                                <td>@ed?.DateCreated?.ToString("MM-dd-yyyy")</td>
                                <td>
                                    <button class="badge btn-success"
                                            @onclick="@(() => ViewDetails(ed?.Id))"
                                            disabled="@((ed?.Id is null))">
                                        View
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- PAGINATION -->
            <div class="mt-3 d-flex justify-content-center align-items-center gap-2">
                <button class="jf-btn-secondary" @onclick="PreviousPage" disabled="@(!CanGoPrevious)">Previous</button>
                <span>Page @currentPage of @totalPages</span>
                <button class="jf-btn-secondary" @onclick="NextPage" disabled="@(!CanGoNext)">Next</button>
            </div>
        }

        <!-- DETAILS MODAL -->
        @if (showModal)
        {
            <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-xl modal-dialog-centered">
                    <div class="modal-content">

                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">Establishment Details</h5>
                            <button type="button" class="btn-close" @onclick="CloseModal"></button>
                        </div>

                        <div class="modal-body">

                            @if (detailsLoading)
                            {
                                <div class="text-center my-3">
                                    <div class="spinner-border"></div>
                                    <p>Loading details...</p>
                                </div>
                            }
                            else if (detailsData is not null)
                            {
                                var d = detailsData.EmployerDetails;

                                <h5 class="fw-bold">General Information</h5>

                                @if (d != null && !string.IsNullOrWhiteSpace(d.EstablishmentName))
                                {
                                    <ul>
                                        <li><strong>Name:</strong> @d.EstablishmentName</li>
                                        <li><strong>Owner / Contact:</strong> @d.ContactFullName</li>
                                        <li><strong>Email:</strong> @d.ContactEmailAddress</li>
                                        <li><strong>Address:</strong> @d.Address</li>
                                        <li><strong>Status:</strong> @GetStatusText(d.Status)</li>
                                    </ul>
                                }
                                else
                                {
                                    <p class="text-danger fw-bold">⚠ Employer details are missing or invalid.</p>
                                }

                                <hr />

                                <h5 class="fw-bold">Attachments</h5>

                                @if (employerFiles != null && employerFiles.Any())
                                {
                                    <ul>
                                        @foreach (var att in employerFiles)
                                        {
                                            var fileUrl = $"http://localhost:5167/files/employer/{att.FolderName}/{att.FileName}";
                                            <li>
                                                <a href="@fileUrl" target="_blank">@att.FileName</a>
                                                <span class="text-muted">(@att.FileSize)</span>
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <p class="text-muted">No attachments uploaded.</p>
                                }


                                <hr />

                                <h5 class="fw-bold">Job Vacancies</h5>

                                @if (d != null && d.JobPosts != null && d.JobPosts.Any())
                                {
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Description</th>
                                                <th>Slots</th>
                                                <th>Salary</th>
                                                <th>Date Posted</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var job in d.JobPosts)
                                            {
                                                <tr>
                                                    <td>@job.Description</td>
                                                    <td>@job.NumberOfVacancy</td>
                                                    <td>@job.Salary</td>
                                                    <td>@job.DatePosted.ToString("MM-dd-yyyy")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                }
                                else
                                {
                                    <p class="text-muted">No listed job vacancies.</p>
                                }
                            }
                        </div>

                        <div class="modal-footer">
                            @if (detailsData?.EmployerDetails?.Status == ProjectConfig.ACCOUNT_STATUS.PENDING)
                            {
                                <button class="nsrp-toggle bg-success" @onclick="ApproveEstablishment">Approve</button>
                                <button class="nsrp-toggle bg-danger" @onclick="DenyEstablishment">Deny</button>
                            }
                            else
                            {
                                <span class="text-muted">Status already set.</span>
                            }

                            <button class="nsrp-toggle" @onclick="CloseModal">Close</button>
                        </div>

                    </div>
                </div>
            </div>
        }
    </div>
</div>
@code {

    private int selectedStatus = 0;
    private bool isLoading = false;
    private string? errorMessage;

    private List<EstablishmentViewModel> establishments = new();

    private int currentPage = 1;
    private int totalPages = 1;
    private int pageSize = 10;

    private IEnumerable<EstablishmentViewModel> pagedEstablishments =>
        establishments.Skip((currentPage - 1) * pageSize).Take(pageSize);

    private bool CanGoNext => currentPage < totalPages;
    private bool CanGoPrevious => currentPage > 1;

    private bool showModal = false;
    private bool detailsLoading = false;
    private List<AttachementsViewModel> employerFiles = new();
    private EmployerRegistrationViewModel? detailsData;

    protected override async Task OnInitializedAsync()
    {
        await LoadEstablishments();
    }

    private async Task ChangeStatus(int status)
    {
        selectedStatus = status;
        currentPage = 1;
        await LoadEstablishments();
    }

    private async Task LoadEstablishments()
    {
        isLoading = true;

        try
        {
            var url = $"/api/Manager/GetEstablishments/{selectedStatus}";
            var result = await Http.GetFromJsonAsync<List<EstablishmentViewModel>>(url);

            establishments = result ?? new();
            totalPages = Math.Max(1, (int)Math.Ceiling(establishments.Count / (double)pageSize));
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }

        isLoading = false;
    }
    private async Task LoadEmployerFiles(string employerId)
    {
        try
        {
            employerFiles = await Http.GetFromJsonAsync<List<AttachementsViewModel>>(
                $"/api/Employer/GetEmployerFiles/{employerId}"
            ) ?? new List<AttachementsViewModel>();
        }
        catch
        {
            employerFiles = new();
        }
    }
    private async Task ViewDetails(string? id)
    {
        if (id is null) return;

        showModal = true;
        detailsLoading = true;

        try
        {
            // Load establishment core info
            detailsData = await Http.GetFromJsonAsync<EmployerRegistrationViewModel>(
                $"/api/Employer/GetEstablishmentDataWithUserAccountId/{id}");

            // Load attachments
            await LoadEmployerFiles(id);
        }
        catch
        {
            detailsData = null;
        }

        detailsLoading = false;
    }

    private void NextPage()
    {
        if (CanGoNext)
            currentPage++;
    }

    private void PreviousPage()
    {
        if (CanGoPrevious)
            currentPage--;
    }

    private void CloseModal()
    {
        showModal = false;
    }

    private string GetStatusText(ProjectConfig.ACCOUNT_STATUS? status)
    {
        return status switch
        {
            ProjectConfig.ACCOUNT_STATUS.PENDING => "Pending",
            ProjectConfig.ACCOUNT_STATUS.APPROVED => "Approved",
            ProjectConfig.ACCOUNT_STATUS.DENIED => "Denied",
            _ => "Unknown"
        };
    }
    private async Task ApproveEstablishment()
    {
        if (detailsData?.EmployerDetails?.Id == null)
            return;

        var employerId = detailsData.EmployerDetails.Id;

        if (!await JS.InvokeAsync<bool>("confirm", "Approve this establishment?"))
            return;

        var response = await Http.GetAsync($"/api/Manager/ApproveEstablishment/{employerId}");

        if (response.IsSuccessStatusCode)
        {
            await JS.InvokeVoidAsync("alert", "Establishment approved!");
            CloseModal();
            await LoadEstablishments(); // refresh list
            StateHasChanged();
        }
        else
        {
            var err = await response.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alert", $"Failed to approve: {err}");
        }
    }

    private async Task DenyEstablishment()
    {
        if (detailsData?.EmployerDetails?.Id == null)
            return;

        var employerId = detailsData.EmployerDetails.Id;

        if (!await JS.InvokeAsync<bool>("confirm", "Deny this establishment?"))
            return;

        var response = await Http.GetAsync($"/api/Manager/DenyEstablishment/{employerId}");

        if (response.IsSuccessStatusCode)
        {
            await JS.InvokeVoidAsync("alert", "Establishment denied!");
            CloseModal();
            await LoadEstablishments(); // refresh list
            StateHasChanged();
        }
        else
        {
            var err = await response.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alert", $"Failed to deny: {err}");
        }
    }

}
