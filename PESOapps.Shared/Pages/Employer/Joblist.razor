@page "/Joblist/employer"
@using System.Text.Json
@inject NavigationManager Navigation
@inject HttpClient Http
@inject IJSRuntime JS
@using webapi_peso.Model
@using webapi_peso.ViewModels

@if (!isUserLoggedIn)
{
    <p>Redirecting to login...</p>
}
else if (profile == null)
{
    <p>Loading profile...</p>
}
else if (jobPosts == null)
{
    <p>Loading jobs...</p>
}
else if (!jobPosts.Any())
{
    <div class="no job-board">
        <p>No job postings available.</p>
        <div class="no-filter-bars">
            <button type="button" class="nsrp-toggle" @onclick="() => showAddJobModal = true">+ Post a Job</button>
        </div>
        @if (showAddJobModal)
        {
            <div class="modal-overlay">
                <div class="addjob-modal-content">
                    <h3>Post a Job</h3>

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="error-box">
                            <p>@errorMessage</p>
                        </div>
                    }
                    <div class="addjob-cont">
                        <div class="nsrp-grid">
                            <div>
                                <label>Job Title</label>
                                <input type="text" class="nsrp-input" @bind="newJob.Description" />
                                <p class="mud-input-helper-text">e.g. Service Crew, Data Encoder, Web Designer, etc.</p>
                            </div>
                            <div>
                                <label>Job Description</label>
                                <textarea class="nsrp-input" @bind="newJob.Description2"></textarea>
                                <p class="mud-input-helper-text">Please include the requirements, qualifications, instructions, etc.</p>
                            </div>
                        </div>

                        <div class="nsrp-grid">
                            <div>
                                <label>Educational Attainment</label>
                                <select class="nsrp-input" @bind="newJob.EducationalAttainment">
                                    <option value="">Select</option>
                                    <option value="HIGH SCHOOL LEVEL">HIGH SCHOOL LEVEL</option>
                                    <option value="HIGH SCHOOL GRADUATE">HIGH SCHOOL GRADUATE</option>
                                    <option value="COLLEGE LEVEL">COLLEGE LEVEL</option>
                                    <option value="COLLEGE GRADUATE">COLLEGE GRADUATE</option>
                                    <option value="POST GRADUATE/MASTERS DEGREE">POST GRADUATE/MASTERS DEGREE</option>
                                </select>
                            </div>

                            <div>
                                <label>Work Experience</label>
                                <select class="nsrp-input" @bind="newJob.WorkExperience">
                                    <option value="">Select</option>
                                    <option value="Less than a year">Less than a year</option>
                                    <option value="1 - 3 years">1 - 3 years</option>
                                    <option value="3 - 5 years">3 - 5 years</option>
                                    <option value="5+ years">5+ years</option>
                                </select>
                            </div>

                            <div>
                                <label>Number of Vacancy</label>
                                <input type="number"
                                       class="nsrp-input"
                                       @bind="newJob.NumberOfVacancy" required />
                            </div>

                            <div>
                                <label>Gender</label>
                                <select class="nsrp-input" @bind="newJob.Gender">
                                    <option value="">Select</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Any">Any</option>
                                </select>
                            </div>

                            <div>
                                <label>Age From</label>
                                <input type="number" class="nsrp-input" @bind="newJob.AgeFrom" required />
                            </div>

                            <div>
                                <label>Age To</label>
                                <input type="number" class="nsrp-input" @bind="newJob.AgeTo" required />
                            </div>

                            <div>
                                <label>Civil Status</label>
                                <input type="text"
                                       class="nsrp-input"
                                       @bind="newJob.CivilStatus" />
                            </div>

                            <div>
                                <label>Expected Salary (₱)</label>
                                <input type="number"
                                       class="nsrp-input"
                                       @bind="newJob.Salary" />
                            </div>
                        </div>

                        <div class="reason-section">
                            <label><strong>Reason for Job Opening:</strong></label>

                            <div>
                                <input type="checkbox" id="reasonExpansion" @bind="ReasonExpansion" />
                                <label for="reasonExpansion">Expansion</label>
                            </div>

                            <div>
                                <input type="checkbox" id="reasonReplaceMent" @bind="ReasonReplaceMent" />
                                <label for="reasonReplaceMent">Replacement</label>
                            </div>

                            <div>
                                <input type="checkbox" id="reasonOthers" @bind="ReasonOthers" />
                                <label for="reasonOthers">Others</label>
                            </div>
                        </div>

                    </div>
                    <!-- Optional extra fields -->
                    <div class="modal-actions">
                        <button class="nsrp-toggle" @onclick="PostAJob">Submit</button>
                        <button class="nsrp-toggle" @onclick="() => showAddJobModal = false">Cancel</button>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <div class="job-board">

        @if (showAddJobModal)
        {
            <div class="modal-overlay">
                <div class="addjob-modal-content">
                    <h3>Post a Job</h3>

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="error-box">
                            <p>@errorMessage</p>
                        </div>
                    }
                    <div class="addjob-cont">
                        <div class="nsrp-grid">
                            <div>
                                <label>Job Title</label>
                                <input type="text" class="nsrp-input" @bind="newJob.Description" />
                                <p class="mud-input-helper-text">e.g. Service Crew, Data Encoder, Web Designer, etc.</p>
                            </div>
                            <div>
                                <label>Job Description</label>
                                <textarea class="nsrp-input" @bind="newJob.Description2"></textarea>
                                <p class="mud-input-helper-text">Please include the requirements, qualifications, instructions, etc.</p>
                            </div>
                        </div>

                        <div class="nsrp-grid">
                            <div>
                                <label>Educational Attainment</label>
                                <select class="nsrp-input" @bind="newJob.EducationalAttainment">
                                    <option value="">Select</option>
                                    <option value="HIGH SCHOOL LEVEL">HIGH SCHOOL LEVEL</option>
                                    <option value="HIGH SCHOOL GRADUATE">HIGH SCHOOL GRADUATE</option>
                                    <option value="COLLEGE LEVEL">COLLEGE LEVEL</option>
                                    <option value="COLLEGE GRADUATE">COLLEGE GRADUATE</option>
                                    <option value="POST GRADUATE/MASTERS DEGREE">POST GRADUATE/MASTERS DEGREE</option>
                                </select>
                            </div>

                            <div>
                                <label>Work Experience</label>
                                <select class="nsrp-input" @bind="newJob.WorkExperience">
                                    <option value="">Select</option>
                                    <option value="Less than a year">Less than a year</option>
                                    <option value="1 - 3 years">1 - 3 years</option>
                                    <option value="3 - 5 years">3 - 5 years</option>
                                    <option value="5+ years">5+ years</option>
                                </select>
                            </div>

                            <div>
                                <label>Number of Vacancy</label>
                                <input type="number"
                                       class="nsrp-input"
                                       @bind="newJob.NumberOfVacancy" required />
                            </div>

                            <div>
                                <label>Gender</label>
                                <select class="nsrp-input" @bind="newJob.Gender">
                                    <option value="">Select</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Any">Any</option>
                                </select>
                            </div>

                            <div>
                                <label>Age From</label>
                                <input type="number" class="nsrp-input" @bind="newJob.AgeFrom" required />
                            </div>

                            <div>
                                <label>Age To</label>
                                <input type="number" class="nsrp-input" @bind="newJob.AgeTo" required />
                            </div>

                            <div>
                                <label>Civil Status</label>
                                <input type="text"
                                       class="nsrp-input"
                                       @bind="newJob.CivilStatus" />
                            </div>

                            <div>
                                <label>Expected Salary (₱)</label>
                                <input type="number"
                                       class="nsrp-input"
                                       @bind="newJob.Salary" />
                            </div>
                        </div>

                        <div class="reason-section">
                            <label><strong>Reason for Job Opening:</strong></label>

                            <div>
                                <input type="checkbox" id="reasonExpansion" @bind="ReasonExpansion" />
                                <label for="reasonExpansion">Expansion</label>
                            </div>

                            <div>
                                <input type="checkbox" id="reasonReplaceMent" @bind="ReasonReplaceMent" />
                                <label for="reasonReplaceMent">Replacement</label>
                            </div>

                            <div>
                                <input type="checkbox" id="reasonOthers" @bind="ReasonOthers" />
                                <label for="reasonOthers">Others</label>
                            </div>
                        </div>


                    </div>
                    <!-- Optional extra fields -->
                    <div class="modal-actions">
                        <button class="nsrp-toggle" @onclick="PostAJob">Submit</button>
                        <button class="nsrp-toggle" @onclick="() => showAddJobModal = false">Cancel</button>
                    </div>
                </div>
            </div>
        }
        <div class="job-list">
            <!-- 🔍 Search Bar -->
            <div class="filter-bars">
                <button class="nsrp-toggle" @onclick="() => showAddJobModal = true">+ Post a Job</button>
            </div>
            @foreach (var post in jobPosts.OrderByDescending(p => p.DatePosted))
            {
                bool isExpired = post.Expiry < DateTime.Now;

                <div class="job-card @(selectedJobPost?.Id == post.Id ? "selected" : "")"
                     @onclick="@(() => SelectJob(post))">
                    <div class="card-name elips">@post.Description</div>
                    @if (isExpired)
                    {
                        <p class="muted" style="color:red;"><strong>This job has expired.</strong></p>
                    }
                    else
                    {
                        <strong>AVAILABLE</strong>
                    }
                    <p class="card-date">
                        <em>@(post.DatePosted.ToString("MMMM dd, yyyy"))</em>
                    </p>
                </div>
            }
        </div>

        <div class="job-details Emp">
            <div class="job-div">
                @if (selectedJobPost != null)
                {
                    bool isExpired = selectedJobPost.Expiry < DateTime.Now;

                    <div class="card-name">@selectedJobPost.Description</div>
                    @if (isExpired)
                    {
                        <p class="muted" style="color:red;"><strong>This job has expired.</strong></p>
                    }
                    else
                    {
                        <strong>AVAILABLE</strong>
                    }
                    <p class="card-date">
                        <em>@(selectedJobPost.DatePosted.ToString("MMMM dd, yyyy"))</em>
                    </p>
                    <p class="card-details-sal">
                        @string.Format(new System.Globalization.CultureInfo("en-PH"), "{0:C}", selectedJobPost.Salary ?? 0)
                    </p>
                    <hr />
                    <div class="details-inner">
                        <strong>Description:</strong>
                        <p class="card-description">@selectedJobPost.Description2</p>
                    </div>

                }
                else
                {
                    <p>Select a job to see details.</p>
                }
            </div>
            <div class="job-div">
              <!-- ───────────── Applicants table ───────────── -->
               <h5 class="mt-4 mb-2">Applicants</h5>
                 <div class="table-scroll">
                    @if (isApplicantsLoading)
                    {
                        <div class="custom-loader"></div>
                    }
                    else if (applicants?.Any() == true)
                    {
                        <table class="table table-bordered table-striped">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Applied On</th>
                                    <th>Interviewed</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var a in applicants!)
                                {
                                    <tr>
                                        <td data-label="Name">@a.Applicant?.FirstName @a.Applicant?.MiddleName @a.Applicant?.SurName @a.Applicant?.Suffix</td>
                                        <td data-label="Email">@a.Applicant?.Email</td>
                                        <td data-label="Applied On">@a.DateApplied.ToString("MMMM dd, yyyy")</td>
                                        <td data-label="Interviewed">@(a.IsInterviewed ? "interviewed" : "Not yet")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p class="fst-italic">No applicants for this job yet.</p>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    private AccountAndInformationViewModel? profile;
    private bool isUserLoggedIn = false;
    private bool loaded = false;

    private EmployerDetails? employerDetails;
    private List<EmployerJobPost>? jobPosts;
    private EmployerJobPost? selectedJobPost;

    private string initialBearerToken = "your-bearer-token-here";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !loaded)
        {
            loaded = true;

            var userId = await JS.InvokeAsync<string>("localStorage.getItem", "UserId");
            var token = await JS.InvokeAsync<string>("localStorage.getItem", "Token");
            var isLoggedIn = await JS.InvokeAsync<string>("localStorage.getItem", "IsLoggedIn");

            if (!string.IsNullOrWhiteSpace(userId) && isLoggedIn == "true")
            {
                isUserLoggedIn = true;

                Http.DefaultRequestHeaders.Authorization =
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

                try
                {
                    var profileResponse = await Http.GetAsync($"api/Applicant/GetApplicantProfile/{userId}");
                    if (profileResponse.IsSuccessStatusCode)
                    {
                        var json = await profileResponse.Content.ReadAsStringAsync();
                        profile = JsonSerializer.Deserialize<AccountAndInformationViewModel>(json, new JsonSerializerOptions
                        {
                            PropertyNameCaseInsensitive = true 
                        });

                        var jobResponse = await Http.GetAsync($"api/Employer/GetEstablishmentDataWithUserAccountId/{userId}");
                        if (jobResponse.IsSuccessStatusCode)
                        {
                            var rawJson = await jobResponse.Content.ReadAsStringAsync();
                            var employerData = JsonSerializer.Deserialize<EmployerRegistrationViewModel>(rawJson, new JsonSerializerOptions
                            {
                                PropertyNameCaseInsensitive = true
                            });

                            if (employerData != null)
                            {
                                employerDetails = employerData.EmployerDetails;
                                jobPosts = employerDetails?.JobPosts ?? new List<EmployerJobPost>();
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine("Error: " + ex.Message);
                }

                StateHasChanged();
            }
            else
            {
                Navigation.NavigateTo("/pesobeta/Login", forceLoad: true);
            }
        }
    }
    // ────────────────────────── helpers ──────────────────────────

    private List<AppliedApplicantViewModel>? applicants;
    private bool isApplicantsLoading;

    private async void SelectJob(EmployerJobPost post)
    {
        if (selectedJobPost?.Id == post.Id) return; // already showing

        selectedJobPost = post;
        applicants = null;
        isApplicantsLoading = true;
        StateHasChanged();

        await LoadApplicantsAsync(post.Id!);
    }

    private async Task LoadApplicantsAsync(string jobId)
    {
        try
        {
            applicants = await Http.GetFromJsonAsync<List<AppliedApplicantViewModel>>
                ($"api/Employer/GetApplicantsByJobPost/{jobId}") ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error loading applicants: " + ex.Message);
        }
        finally
        {
            isApplicantsLoading = false;
            StateHasChanged();
        }
    }

    <!-- Add Job Post -->
    public bool ReasonExpansion { get; set; }
    public bool ReasonReplaceMent { get; set; }
    public bool ReasonOthers { get; set; }

    private bool showAddJobModal = false;
    private string? errorMessage;
    private EmployerJobPost newJob = new EmployerJobPost
    {
        IsDeleted = false,
        IsVacant = 1,
        ReasonExpansion = false,
        ReasonReplaceMent = false,
        ReasonOthers = false
    };
    private async Task PostAJob()
    {
        // ✅ Validation
        if (string.IsNullOrWhiteSpace(newJob.Description))
        {
            await JS.InvokeVoidAsync("alert", "Job Title is required.");
            return;
        }
        if (string.IsNullOrWhiteSpace(newJob.Description2))
        {
            await JS.InvokeVoidAsync("alert", "Job Description is required.");
            return;
        }
        if (newJob.NumberOfVacancy == null || newJob.NumberOfVacancy <= 0)
        {
            await JS.InvokeVoidAsync("alert", "Please specify number of vacancies.");
            return;
        }
        if (newJob.Salary <= 0)
        {
            await JS.InvokeVoidAsync("alert", "Please provide expected salary.");
            return;
        }
        if (newJob.AgeFrom == null || newJob.AgeFrom <= 0)
        {
            await JS.InvokeVoidAsync("alert", "Please enter Age From.");
            return;
        }
        if (newJob.AgeTo == null || newJob.AgeTo <= 0)
        {
            await JS.InvokeVoidAsync("alert", "Please enter Age To.");
            return;
        }

        try
        {
            // ✅ Set the correct foreign key
            if (employerDetails == null)
            {
                await JS.InvokeVoidAsync("alert", "Cannot post job: Employer details not found.");
                return;
            }

            newJob.EmployerDetailsId = employerDetails.Id; // ✅ Use EmployerDetails.Id
            newJob.Id = Guid.NewGuid().ToString();
            newJob.DatePosted = DateTime.Now;
            newJob.Expiry = DateTime.Now.AddDays(30);

            // Ensure default values
            newJob.IsDeleted = false;
            newJob.IsVacant = 1;
            newJob.ReasonExpansion = ReasonExpansion;
            newJob.ReasonReplaceMent = ReasonReplaceMent;
            newJob.ReasonOthers = ReasonOthers;

            var response = await Http.PostAsJsonAsync("api/Employer/AddJobPost", newJob);

            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "Job post submitted successfully!");

                // ✅ Reset the form values
                newJob = new EmployerJobPost
                {
                    IsDeleted = false,
                    IsVacant = 1,
                    ReasonExpansion = false,
                    ReasonReplaceMent = false,
                    ReasonOthers = false,
                    EmployerDetailsId = employerDetails.Id // keep this since it's needed
                };
                StateHasChanged(); // ✅ refresh UI
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Failed to post job: {error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }


}
