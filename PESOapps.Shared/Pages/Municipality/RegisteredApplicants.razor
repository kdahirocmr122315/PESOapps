@page "/Applicants/municipality"
@using webapi_peso.Model
@using webapi_peso.ViewModels
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation

<PageTitle>Applicants</PageTitle>

<div class="jf-container-list">

    <!-- ===== Header Section ===== -->
    <div class="jf-card jf-header-card d-flex justify-content-between align-items-center">
        <h2>👥 Registered Job Seekers in your area</h2>
        <div class="d-flex gap-2">
            <NavLink href="/pesobeta/Profile/municipality" class="jf-btn-secondary">
                ⬅ Back
            </NavLink>
        </div>
    </div>

    <!-- ===== Loading / Error ===== -->
    @if (loading)
    {
        <div class="jf-loader-container">
            <div class="jf-spinner"></div>
            <p>Loading...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <p class="jf-text-error">@errorMessage</p>
    }
    else
    {
        <!-- ===== Search & Count Section (always visible) ===== -->
        <div class="jf-card jf-filter-card d-flex justify-content-between align-items-center mb-3">
            <input type="text" class="jf-input"
                   placeholder="🔍 Search applicants..."
                   value="@searchQuery"
                   @oninput="OnSearchChanged" />

            <span class="jf-text-muted">
                Showing @PaginatedApplicants.Count() of @FilteredApplicants.Count applicants
            </span>
        </div>

        <!-- ===== Table Section ===== -->
        <div class="jf-card jf-list-card">
            <table class="jf-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Cellphone</th>
                    </tr>
                </thead>
                <tbody>
                    @if (FilteredApplicants == null || FilteredApplicants.Count == 0)
                    {
                        <tr>
                            <td colspan="4" class="jf-text-muted text-center">
                                No applicants found.
                            </td>
                        </tr>
                    }
                    else if (!PaginatedApplicants.Any())
                    {
                        <tr>
                            <td colspan="4" class="jf-text-muted text-center">
                                No applicants match your search.
                            </td>
                        </tr>
                    }
                    else
                    {
                        int index = ((_currentPage - 1) * _pageSize) + 1;
                        foreach (var applicant in PaginatedApplicants)
                        {
                            <tr>
                                <td>@index</td>
                                <td>@applicant.SurName, @applicant.FirstName @applicant.MiddleName</td>
                                <td>@applicant.Email</td>
                                <td>@applicant.CellphoneNumber</td>
                            </tr>
                            index++;
                        }
                    }
                </tbody>
            </table>

            <!-- ===== Pagination Section ===== -->
            @if (_totalPages > 1)
            {
                <div class="jf-pagination">
                    <button class="jf-btn-secondary" @onclick="PreviousPage" disabled="@(_currentPage == 1)">⬅ Previous</button>
                    <span>Page @_currentPage of @_totalPages</span>
                    <button class="jf-btn-secondary" @onclick="NextPage" disabled="@(_currentPage == _totalPages)">Next ➡</button>
                </div>
            }
        </div>
    }
</div>

@code {
    private bool loading = true;
    private string? errorMessage;
    private string searchQuery = string.Empty;
    private string? currentUserId;

    private string baseUrl = "http://localhost:5167/api/Manager";

    private int _currentPage = 1;
    private int _pageSize = 10;
    private int _totalPages => FilteredApplicants == null ? 1 : (int)Math.Ceiling(FilteredApplicants.Count / (double)_pageSize);

    private List<ApplicantInformation> FilteredApplicants = new();

    private IEnumerable<ApplicantInformation> PaginatedApplicants =>
        FilteredApplicants.Skip((_currentPage - 1) * _pageSize).Take(_pageSize);

    private void NextPage()
    {
        if (_currentPage < _totalPages)
            _currentPage++;
    }

    private void PreviousPage()
    {
        if (_currentPage > 1)
            _currentPage--;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            currentUserId = await JS.InvokeAsync<string>("localStorage.getItem", "UserId");
            var token = await JS.InvokeAsync<string>("localStorage.getItem", "Token");

            if (string.IsNullOrEmpty(currentUserId))
            {
                errorMessage = "UserId not found. Please log in again.";
                loading = false;
                return;
            }

            // ✅ Check cache for this user
            if (ApplicantsCache.UserApplicants.TryGetValue(currentUserId, out var cachedApplicants))
            {
                FilteredApplicants = ApplySearch(cachedApplicants);
                loading = false;
                return;
            }

            // ===== Fetch Manager Profile =====
            var managerUrl = $"{baseUrl}/GetPESOManagerAccount/{currentUserId}";
            var managerRequest = new HttpRequestMessage(HttpMethod.Get, managerUrl);
            managerRequest.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var managerResponse = await Http.SendAsync(managerRequest);
            if (!managerResponse.IsSuccessStatusCode)
            {
                errorMessage = $"Failed to fetch manager profile ({managerResponse.StatusCode})";
                loading = false;
                return;
            }

            var managerJson = await managerResponse.Content.ReadAsStringAsync();
            var manager = System.Text.Json.JsonSerializer.Deserialize<PESOManagerAccountViewModel>(managerJson,
                new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (manager == null || string.IsNullOrEmpty(manager.UserInformation.ProvCode) || string.IsNullOrEmpty(manager.UserInformation.CityCode))
            {
                errorMessage = "Invalid manager profile (no ProvCode/CityCode).";
                loading = false;
                return;
            }

            // ===== Fetch Applicants =====
            var applicantsUrl = $"{baseUrl}/GetListOfApplicants/{manager.UserInformation.ProvCode}/{manager.UserInformation.CityCode}";
            var applicantsRequest = new HttpRequestMessage(HttpMethod.Get, applicantsUrl);
            applicantsRequest.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var applicantsResponse = await Http.SendAsync(applicantsRequest);

            if (applicantsResponse.IsSuccessStatusCode)
            {
                var json = await applicantsResponse.Content.ReadAsStringAsync();
                var applicants = System.Text.Json.JsonSerializer.Deserialize<List<ApplicantInformation>>(json,
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? new List<ApplicantInformation>();

                // ✅ Cache this user's applicants
                ApplicantsCache.UserApplicants[currentUserId] = applicants;

                FilteredApplicants = ApplySearch(applicants);
            }
            else
            {
                errorMessage = $"Failed to fetch applicants ({applicantsResponse.StatusCode})";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        searchQuery = e.Value?.ToString() ?? string.Empty;

        if (!string.IsNullOrEmpty(currentUserId) &&
            ApplicantsCache.UserApplicants.TryGetValue(currentUserId, out var cachedApplicants))
        {
            FilteredApplicants = ApplySearch(cachedApplicants);
            _currentPage = 1; // reset to first page when searching
        }
    }

    private List<ApplicantInformation> ApplySearch(List<ApplicantInformation> applicants) =>
        applicants
            .Where(a => string.IsNullOrEmpty(searchQuery) ||
                        $"{a.FirstName} {a.MiddleName} {a.SurName}".Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                        (a.Email ?? "").Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                        (a.CellphoneNumber ?? "").Contains(searchQuery, StringComparison.OrdinalIgnoreCase))
            .ToList();

    public static class ApplicantsCache
    {
        // ✅ Cache applicants per user
        public static Dictionary<string, List<ApplicantInformation>> UserApplicants { get; set; } = new();
    }
}
