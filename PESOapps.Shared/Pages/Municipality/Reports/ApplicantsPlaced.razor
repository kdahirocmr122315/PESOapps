@page "/ApplicantsPlaced/municipality"
@using PESOapps.Shared.Address
@using webapi_peso.Model
@using webapi_peso.ViewModels
@inject HttpClient Http
@inject IJSRuntime JS
@inject AddressService AddressService

<PageTitle>Applicants Placed Report</PageTitle>

<div class="nsrp-container">
    <h3>Applicants Placed Report</h3>

    <div class="jf-card jf-list-card reports">

        <!-- Filters & Actions -->
        <div class="filters-actions">

            <!-- Province -->
            <div class="filters">
                <label>Province</label>
                <select class="nsrp-input" @bind="ProvCode">
                    <option value="">Select Province</option>
                    @foreach (var p in AllProvinces)
                    {
                        <option value="@p.provCode">@p.provDesc</option>
                    }
                </select>
            </div>

            <!-- City/Municipality -->
            <div class="filters">
                <label>City / Municipality</label>
                <select class="nsrp-input" @bind="CityCode">
                    <option value="">Select City / Municipality</option>
                    @foreach (var c in FilteredCities)
                    {
                        <option value="@c.citymunCode">@c.citymunDesc</option>
                    }
                </select>
            </div>

            <!-- Month -->
            <div class="filters">
                <label>Month:</label>
                <select @bind="selectedMonth">
                    @for (int m = 1; m <= 12; m++)
                    {
                        <option value="@m">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)</option>
                    }
                </select>
            </div>

            <!-- Year -->
            <div class="filters">
                <label>Year:</label>
                <select @bind="selectedYear">
                    @for (int y = DateTime.Now.Year; y >= 2000; y--)
                    {
                        <option value="@y">@y</option>
                    }
                </select>
            </div>

            <div class="actions align-self-end">
                <button class="nsrp-toggle" @onclick="LoadReport">Search</button>
                <button class="nsrp-toggle" @onclick="ExportExcel">Export Excel</button>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <p><em>Loading report...</em></p>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <p class="error">@errorMessage</p>
    }
    else if (reportData != null && reportData.Any())
    {
        <!-- ✅ REPORT TABLE -->
        <div id="print-section">
            <h5>APPLICANTS PLACED REPORT</h5>
            <h6>
                @System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(selectedMonth)
                @selectedYear
            </h6>
            <h6>
                @(FilteredCities.FirstOrDefault(c => c.citymunCode == CityCode)?.citymunDesc),
                @(AllProvinces.FirstOrDefault(p => p.provCode == ProvCode)?.provDesc)
            </h6>

            <div class="table-scroll">
                <table class="report-table jf-table">
                    <thead>
                        <tr>
                            <th>Applicant Name</th>
                            <th>As (Position)</th>
                            <th>TO (Employer)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in PagedData)
                        {
                            <tr>
                                <td>@item.ApplicantName</td>
                                <td>@item.JobTitle</td>
                                <td>@item.Company</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            @if (totalPages > 1)
            {
                <div class="pagination-controls no-print">
                    <button class="nsrp-toggle" @onclick="PrevPage" disabled="@(!CanPrev)">Previous</button>
                    <span>Page @currentPage of @totalPages</span>
                    <button class="nsrp-toggle" @onclick="NextPage" disabled="@(!CanNext)">Next</button>
                </div>
            }
        </div>
    }
    else
    {
        <p>No applicants placed found for this city and period.</p>
    }
</div>

@code {
    private string ProvCode = "1043"; // default MISAMIS ORIENTAL
    private string CityCode = "";
    private int selectedMonth = DateTime.Now.Month;
    private int selectedYear = DateTime.Now.Year;

    private bool isLoading = false;
    private string? errorMessage;
    private List<JobApplicantsPlaced> reportData = new();

    // Pagination
    private int currentPage = 1;
    private int pageSize = 20;
    private int totalPages => (int)Math.Ceiling((double)reportData.Count / pageSize);
    private IEnumerable<JobApplicantsPlaced> PagedData =>
        reportData.Skip((currentPage - 1) * pageSize).Take(pageSize);

    private bool CanPrev => currentPage > 1;
    private bool CanNext => currentPage < totalPages;

    private List<Province> AllProvinces = new();
    private List<CityMunicipality> AllCities = new();

    private IEnumerable<CityMunicipality> FilteredCities =>
        AllCities?.Where(c => c.provCode == ProvCode) ?? Enumerable.Empty<CityMunicipality>();

    protected override async Task OnInitializedAsync()
    {
        AllProvinces = await AddressService.GetProvincesAsync();
        AllCities = await AddressService.GetCitiesAsync();
    }

    private async Task LoadReport()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            if (string.IsNullOrEmpty(CityCode))
            {
                errorMessage = "Please select a City/Municipality.";
                return;
            }

            var response = await Http.GetFromJsonAsync<List<JobApplicantsPlaced>>(
                $"api/Manager/GetHiredApplicantsList/{selectedMonth}/{selectedYear}/{CityCode}/false");

            reportData = response ?? new List<JobApplicantsPlaced>();
            currentPage = 1;
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load report: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ExportExcel()
    {
        try
        {
            if (string.IsNullOrEmpty(CityCode))
            {
                errorMessage = "Please select a City/Municipality.";
                return;
            }

            var url = $"api/Manager/GetHiredApplicantsList/{selectedMonth}/{selectedYear}/{CityCode}/true";
            var response = await Http.GetStringAsync(url);
            await JS.InvokeVoidAsync("open", response.Replace("\"", ""), "_blank");
        }
        catch (Exception ex)
        {
            errorMessage = $"Export failed: {ex.Message}";
        }
    }

    private void PrevPage() { if (CanPrev) currentPage--; }
    private void NextPage() { if (CanNext) currentPage++; }
}
